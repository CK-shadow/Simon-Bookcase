---
title: 网络通信模型和协程
tags: 
 - Web
 - Gevent
categories: frontEnd
---

### 网络通信模型
**通信模型分类**  
1. 循环网络模型：循环接收客户端请求，同时只能处理一个客户端请求任务，处理完再进行下一个
   * 优点：实现简单，占用资源少
   * 缺点：无法同时处理多个请求，效率不高
   * 适用情况：客户端不会长时间占用服务器，任务比较小，任务量不大，udp比tcp实现更简单
2. IO并发网络模型：利用IO多路复用等IO模型技术，同时处理多个IO任务请求
   * 优点：资源消耗少，能同时处理多个IO
   * 缺点：只能处理IO操作
3. 多进程/线程并发：当一个客户端连接服务器，就创建一个新的进程/线程处理客户端请求，客户端退出时进程/线程销毁
   * 优点：同时满足多个客户端同时占用服务器需求，可以处理各种请求
   * 缺点：资源消耗大
   * 使用情况：客户端请求比较复杂，处理事件较长，配合较强的服务器部署技术（负载均衡，集群技术，分布式处理等）
            
**多进程网络并发**  
基于fork的并发模型
* 创建监听套接字
* 循环等待客户端连接
* 有客户端连接创建新的进程处理客户端请求
* 原进程继续等待其他客户端连接
* 如果客户端退出，则销毁对应进程
            
### 协程技术
* 定义 ： 纤程，微线程,是为非抢占式多任务产生子程序的计算机组件。协程允许不同入口点在不同位置开始或者暂停，简单来说，协程就是可以暂停执行的函数
* 协程本质就是一个可以暂停执行的函数。当该函数暂停时可以跳出函数执行其他内容，重新加载时可以继续执行而不是重新执行
* yield 在python中时实现原生协程的关键字
* 协程原理：记录一个函数的上下文栈帧，协程切换调度时会将记录的栈帧位置保存起来，切换回来时再进行调取，恢复原有执行内容，从上次位置继续执行
* 协程优缺点
  * 优点 ： 占用资源少，效率高，可以同时在应用层完成多个任务
  * 缺点 ： 无法利用计算机多核
    	
**协程模块**  
greenlet  
*  sudo  pip3 install  greenlet
*  函数
```python
greenlet.greenlet(func)
    功能: 创建协程对象
    参数：协程函数

g.switch()
    功能: 选择执行的协程
```
    
gevent  
安装：  
```python
sudo  pip3 install gevent
```
函数
```
gevent.spawn(func,argv,...)
    功能 ： 生成协程对象
    参数 ： func  协程函数
    		argv  协程函数参数
    返回值： 协程对象

gevent.joinall(list,[timeout])
    功能: 阻塞等待协程执行完毕
    参数: list  协程对象列表

gevent.sleep(sec)
    功能： gevent睡眠阻塞
    * gevent协程只有遇到gevent标记的阻塞行为才会自动跳转

1. monkey插件 
    功能：使普通的pythonIO阻塞行为变为可以触发gevent协程阻塞的行为
    使用： from  gevent  import  monkey
    在模块导入前，运行响应的monkey插件函数
    e.g. 
    	monkey.patch_all()
    	monkey.patch_socket()
```
        
